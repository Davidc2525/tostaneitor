<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tostaneitor 3000 - Rediseñado</title>
    <!-- Fuente Inter de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Iconos de Google Material Design -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /*
        ========================================
        NUEVO DISEÑO RADICAL - TOSTANEITOR 3000
        ========================================
        */

        :root {
            /* Colores modo oscuro (Default) */
            --bg-dark: #121212;
            --surface-dark: #1e1e1e;
            --primary-dark: #00e5ff; /* Cyan vibrante */
            --primary-variant-dark: #00b8d4;
            --secondary-dark: #ff4081; /* Rosa para acentos */
            --text-primary-dark: #e0e0e0;
            --text-secondary-dark: #a0a0a0;
            --divider-dark: #2f2f2f;
            --glow-color-dark: rgba(0, 229, 255, 0.25);
            --error-main-dark: #ff5252;
            --success-main-dark: #00c853;
            --warning-main-dark: #ffab40;

            /* Colores modo claro */
            --bg-light: #f5f5f7;
            --surface-light: #ffffff;
            --primary-light: #007aff; /* Azul Apple */
            --primary-variant-light: #0056b3;
            --secondary-light: #34c759; /* Verde */
            --text-primary-light: #1d1d1f;
            --text-secondary-light: #6e6e73;
            --divider-light: #e5e5e5;
            --glow-color-light: rgba(0, 122, 255, 0.2);
            --error-main-light: #d32f2f;
            --success-main-light: #2e7d32;
            --warning-main-light: #f57c00;

            /* Colores del gráfico (independientes del tema) */
            --chart-int-color: var(--primary-dark);
            --chart-loaded-int-color: #f06292; /* Rosa claro para datos cargados */

            /* Variables de transición y estilo */
            --main-transition: all 0.3s ease;
            --border-radius: 16px;
        }

        /* Aplicación de tema inicial */
        body {
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --primary: var(--primary-dark);
            --primary-variant: var(--primary-variant-dark);
            --secondary: var(--secondary-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --divider: var(--divider-dark);
            --glow-color: var(--glow-color-dark);
            --error-main: var(--error-main-dark);
            --success-main: var(--success-main-dark);
            --warning-main: var(--warning-main-dark);
        }

        body.light-theme {
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --primary: var(--primary-light);
            --primary-variant: var(--primary-variant-light);
            --secondary: var(--secondary-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --divider: var(--divider-light);
            --glow-color: var(--glow-color-light);
            --error-main: var(--error-main-light);
            --success-main: var(--success-main-light);
            --warning-main: var(--warning-main-light);
        }

        /* Estilos generales y Resets */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            transition: var(--main-transition);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Card: Contenedor base para secciones */
        .card {
            background-color: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            border: 1px solid var(--divider);
            transition: var(--main-transition);
        }

        /* Header / App Bar */
        .app-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background-color: var(--surface);
            border-radius: var(--border-radius);
            border: 1px solid var(--divider);
        }

        .app-bar h1 {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary);
            text-shadow: 0 0 10px var(--glow-color);
            transition: var(--main-transition);
        }

        .app-bar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        #theme-toggle {
            background: none;
            border: 1px solid var(--divider);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            color: var(--text-secondary);
            display: grid;
            place-items: center;
            transition: var(--main-transition);
        }
        #theme-toggle:hover {
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 10px var(--glow-color);
        }
        
        .status-chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            background-color: var(--divider);
            color: var(--text-secondary);
            transition: var(--main-transition);
        }
        .status-chip.success { background-color: var(--success-main); color: #fff; }
        .status-chip.error { background-color: var(--error-main); color: #fff; }

        /* Status Dashboard: Temp Display + Indicator Chart */
        .status-dashboard {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 16px;
        }
        @media (max-width: 900px) {
            .status-dashboard { grid-template-columns: 1fr; }
        }

        .temp-display-wrapper {
            background-color: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            border: 1px solid var(--divider);
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }
        
        #current-large-temp {
            font-size: clamp(3rem, 10vw, 5rem);
            font-weight: 800;
            color: var(--primary);
            line-height: 1.1;
            text-shadow: 0 0 15px var(--glow-color);
        }

        #current-large-delta {
            font-size: clamp(1rem, 4vw, 1.25rem);
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .chart-canvas-container-2 {
            position: relative;
            min-height: 250px;
            background-color: var(--surface);
            border-radius: var(--border-radius);
            border: 1px solid var(--divider);
            padding: 16px;
        }

        /* Main Chart Section */
        .chart-section {
            background-color: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            border: 1px solid var(--divider);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chart-canvas-container {
            position: relative;
            width: 100%;
            height: 60vh;
            min-height: 400px;
        }
        
        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Quick Actions Buttons */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--divider);
        }

        /* General Button Style */
        .button {
            padding: 12px 18px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--main-transition);
            border: 1px solid transparent;
            font-size: 0.95rem;
            text-transform: none;
        }
        .button .material-icons {
            font-size: 1.25rem;
        }
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--divider);
            color: var(--text-secondary);
        }

        .button.primary {
            background-color: var(--primary);
            color: var(--bg-dark);
            border-color: var(--primary);
        }
        .button.primary:not(:disabled):hover {
            background-color: var(--primary-variant);
            border-color: var(--primary-variant);
            box-shadow: 0 4px 20px var(--glow-color);
            transform: translateY(-2px);
        }
        
        .button.secondary {
            background-color: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--divider);
        }
        .button.secondary:not(:disabled):hover {
            color: var(--primary);
            border-color: var(--primary);
        }

        /* Tabs for Controls */
        .controls-tabs-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        nav.tabs {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid var(--divider);
            padding: 0 8px;
        }
        .tab-button {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: var(--main-transition);
        }
        .tab-button:hover {
            color: var(--text-primary);
        }
        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .section-title {
            font-size: 1.25rem;
            color: var(--text-primary);
            font-weight: 700;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--divider);
            margin-bottom: 8px;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }
        .button-group .button {
            flex-grow: 1;
        }

        /* Form Elements */
        .text-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .text-field label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .text-field input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--divider);
            background-color: var(--bg);
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--main-transition);
        }
        .text-field input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--glow-color);
        }

        /* Toggle Switch */
        .save-toggle-field {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--bg);
            padding: 12px;
            border-radius: 8px;
        }
        .save-toggle-field label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--divider);
            transition: .4s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute; content: "";
            height: 20px; width: 20px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 100%;
        }
        input:checked + .toggle-slider { background-color: var(--primary); }
        input:checked + .toggle-slider:before { transform: translateX(22px); }

        /* Session List */
        .session-list-container {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px; /* For scrollbar */
        }
        .session-list { list-style: none; }
        .session-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 12px;
            background-color: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--divider);
            transition: var(--main-transition);
        }
        .session-list-item:hover {
             border-color: var(--primary);
        }
        
        .session-list-item-text .id {
            font-weight: bold;
            color: var(--text-primary);
        }
        .session-list-item-text .date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .icon-button {
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--main-transition);
        }
        .icon-button:hover { background-color: var(--divider); color: var(--primary); }
        .icon-button.delete-session-btn:hover { color: var(--error-main); }
        .icon-button .material-icons { font-size: 1.25rem; display: block; }
        
        /* Info Section */
        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 16px;
            font-size: 0.9rem;
        }
        .info-grid div:nth-child(odd) { color: var(--text-secondary); font-weight: 500; }
        .info-grid div:nth-child(even) { text-align: right; color: var(--text-primary); font-weight: 700; }
        .info-grid #last-float-val { color: var(--warning-main); }

        .websocket-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
            padding-top: 16px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: grid; place-items: center;
            z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--surface);
            border-radius: var(--border-radius);
            width: 90%; max-width: 600px;
            display: flex; flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            max-height: 80vh;
            border: 1px solid var(--divider);
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--divider);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { font-size: 1.5rem; color: var(--primary); }
        .modal-close-button {
            background: none; border: none; font-size: 2rem;
            cursor: pointer; color: var(--text-secondary); transition: color 0.2s;
        }
        .modal-close-button:hover { color: var(--primary); }
        .modal-body { padding: 24px; overflow-y: auto; }
        .modal-footer {
            padding: 16px 24px; border-top: 1px solid var(--divider);
            text-align: right;
        }
    </style>
</head>
<body class="dark-theme">
    <div class="app-container">
        
        <header class="app-bar">
            <h1>Tostaneitor 3000</h1>
            <div class="app-bar-actions">
                <div class="status-chip" id="status-message" data-cur-type="info">Iniciando...</div>
                <button class="theme-toggle-button" id="theme-toggle" title="Cambiar Tema">
                    <span class="material-icons">light_mode</span>
                </button>
            </div>
        </header>

        <div class="status-dashboard">
            <div class="temp-display-wrapper">
                <div class="temp-display" id="current-large-temp">0.00°C</div>
                <div class="delta-display" id="current-large-delta">Δ 0.00°C</div>
            </div>
            <div class="chart-canvas-container-2">
                <canvas id="indicator-canvas"></canvas>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-canvas-container">
                <canvas id="data-chart"></canvas>
            </div>
            <div class="quick-actions-grid">
                <button class="button secondary" id="loaded-btn"><span class="material-icons">download</span>Cargado</button>
                <button class="button secondary" id="unloaded-btn"><span class="material-icons">upload</span>Descargado</button>
                <button class="button secondary" id="gas-on-btn"><span class="material-icons">local_fire_department</span>Gas On</button>
                <button class="button secondary" id="more-gas-btn"><span class="material-icons">arrow_circle_up</span>Más Gas</button>
                <button class="button secondary" id="less-gas-btn"><span class="material-icons">arrow_circle_down</span>Menos Gas</button>
                <button class="button secondary" id="gas-off-btn"><span class="material-icons">power_off</span>Gas Off</button>
                <button class="button secondary" id="extractor-on-btn"><span class="material-icons">tune</span>Extractor On</button>
                <button class="button secondary" id="extractor-off-btn"><span class="material-icons">settings_backup_restore</span>Extractor Off</button>
            </div>
        </div>

        <div class="card controls-tabs-container">
            <nav class="tabs">
                <button class="tab-button active" data-tab="control">Control y Sesión</button>
                <button class="tab-button" data-tab="config">Configuración</button>
                <button class="tab-button" data-tab="sessions">Sesiones Anteriores</button>
            </nav>

            <div id="tab-control" class="tab-content active">
                <div class="control-grid">
                    <div class="control-group">
                        <h2 class="section-title">Control Principal</h2>
                        <div class="text-field">
                            <label for="session-name-input">Nombre de la Sesión (opcional)</label>
                            <input type="text" id="session-name-input" placeholder="Ej: Tueste Kenia AA" maxlength="50">
                        </div>
                        <div class="save-toggle-field">
                            <label for="save-session-toggle">Guardar Sesión al Detener</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="save-session-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="button-group">
                            <button class="button primary" id="start-plotting-btn"><span class="material-icons">play_arrow</span>Iniciar</button>
                            <button class="button secondary" id="stop-plotting-btn" disabled><span class="material-icons">pause</span>Detener</button>
                        </div>
                        <button class="button secondary" id="reset-chart-btn"><span class="material-icons">refresh</span>Reiniciar Datos (En vivo)</button>
                         <button class="button primary" id="optimize-profile-btn" style="padding: 12px; font-size: 1.1rem;">
                            <span class="material-icons">lightbulb</span> Optimizar Perfil ✨
                        </button>
                    </div>
                    <div class="control-group">
                        <h2 class="section-title">Información de la Sesión</h2>
                         <div class="info-grid">
                            <div>ID Sesión:</div><div id="roast-session_id">N/A</div>
                            <div>Nombre:</div><div id="roast-session_name">N/A</div>
                            <div>Fecha:</div><div id="roast-date">N/A</div>
                            <br>
                            <div>Último Entero (numInt):</div><div id="last-int-val">N/A</div>
                            <div>Último Flotante (numFloat):</div><div id="last-float-val">N/A</div>
                        </div>
                        <p class="websocket-info">
                            Conectando a: <code id="host-conn"></code>
                        </p>
                    </div>
                </div>
            </div>

            <div id="tab-config" class="tab-content">
                <div class="control-grid">
                    <div class="control-group">
                        <h2 class="section-title">Configuración del Gráfico</h2>
                        <div class="text-field">
                            <label for="minutes-input">Duración del Gráfico (minutos)</label>
                            <input type="number" id="minutes-input" value="20">
                        </div>
                        <div class="text-field">
                            <label for="data-millis-input">Intervalo de Datos (ms)</label>
                            <input type="number" id="data-millis-input" value="1000">
                        </div>
                        <button class="button primary" id="apply-settings-btn"><span class="material-icons">settings</span>Aplicar Configuración</button>
                    </div>
                </div>
            </div>

            <div id="tab-sessions" class="tab-content">
                <div class="control-grid">
                    <div class="control-group">
                        <h2 class="section-title">Sesiones Guardadas</h2>
                        <div class="session-list-container">
                            <ul class="session-list" id="session-list"></ul>
                        </div>
                        <button class="button secondary" id="unload-session-btn" style="display: none;">
                            <span class="material-icons">layers_clear</span> Descargar Sesión del Gráfico
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal para el análisis de Gemini -->
    <div class="modal-overlay" id="optimization-modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="modal-close-button" id="modal-close-btn">×</button>
            </div>
            <div class="modal-body" id="modal-content"></div>
            <div class="modal-footer">
                <button id="modal-confirm-btn" class="button primary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Script de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    // ===================================================================
    // TOSTANEITOR 3000 - CÓDIGO OPTIMIZADO Y REFACTORIZADO
    // ===================================================================
    
    // Módulo de Configuración: Almacena constantes y valores que no cambian.
    const config = {
        HOST: "127.0.0.1",
        WEBSOCKET_URL: (host) => `ws://${host}:8080/temp`,
        API_URL: (host) => `http://${host}:8080/api/v1/temp`,
        RECONNECT_DELAY: 5000, // 5 segundos
        // Clave de API para Gemini. ¡NUNCA EXPONER ESTO EN PRODUCCIÓN!
        // Debería ser gestionado de forma segura en un backend.
        GEMINI_API_KEY: "TU_API_KEY_DE_GEMINI_AQUI", 
        EVENT_TYPES: {
            LOADED: 'loaded',
            UNLOADED: 'unloaded',
            GAS_ON: 'gas_on',
            GAS_OFF: 'gas_off',
            MORE_GAS: 'more_gas',
            LESS_GAS: 'less_gas',
            EXTRACTOR_ON: 'extractor_on',
            EXTRACTOR_OFF: 'extractor_off',
        },
        STATUS_TYPES: {
            INFO: 'info',
            SUCCESS: 'success',
            ERROR: 'error',
            WARNING: 'warning',
        }
    };

    // Módulo de Estado: Contiene todas las variables que definen el estado actual de la app.
    const state = {
        websocket: null,
        dataChart: null,
        indicatorChart: null,
        currentIndex: 0,
        isPlottingActive: false,
        allRoastSessions: [],
        activeSession: null,
        loadedSessionId: null,
        currentTheme: localStorage.getItem('theme') || 'dark',
        chartConfig: {
            minutes: 20,
            dataMillis: 1000,
            get dataRate() { return 60 * (1000 / this.dataMillis); }
        }
    };

    // Módulo DOM: Almacena referencias a todos los elementos HTML para un acceso rápido y centralizado.
    const dom = {
        // Contenedores principales y botones de la app
        themeToggle: document.getElementById('theme-toggle'),
        statusMessage: document.getElementById('status-message'),
        largeTemp: document.getElementById('current-large-temp'),
        largeDelta: document.getElementById('current-large-delta'),
        startPlottingBtn: document.getElementById('start-plotting-btn'),
        stopPlottingBtn: document.getElementById('stop-plotting-btn'),
        resetChartBtn: document.getElementById('reset-chart-btn'),
        sessionList: document.getElementById('session-list'),
        optimizeProfileBtn: document.getElementById('optimize-profile-btn'),
        unloadSessionBtn: document.getElementById('unload-session-btn'),
        hostConnection: document.getElementById("host-conn"),
        // Inputs de configuración
        minutesInput: document.getElementById('minutes-input'),
        dataMillisInput: document.getElementById('data-millis-input'),
        applySettingsBtn: document.getElementById('apply-settings-btn'),
        sessionNameInput: document.getElementById('session-name-input'),
        saveSessionToggle: document.getElementById('save-session-toggle'),
        // Displays de información
        lastIntVal: document.getElementById('last-int-val'),
        lastFloatVal: document.getElementById('last-float-val'),
        roastId: document.getElementById('roast-session_id'),
        roastName: document.getElementById('roast-session_name'),
        roastDate: document.getElementById('roast-date'),
        // Canvas de los gráficos
        chartCanvas: document.getElementById('data-chart'),
        indicatorCanvas: document.getElementById('indicator-canvas'),
        // Botones de eventos rápidos
        eventButtons: {
            loaded: document.getElementById('loaded-btn'),
            unloaded: document.getElementById('unloaded-btn'),
            gas_on: document.getElementById('gas-on-btn'),
            more_gas: document.getElementById('more-gas-btn'),
            less_gas: document.getElementById('less-gas-btn'),
            gas_off: document.getElementById('gas-off-btn'),
            extractor_on: document.getElementById('extractor-on-btn'),
            extractor_off: document.getElementById('extractor-off-btn'),
        },
        // Elementos del Modal
        modal: {
            overlay: document.getElementById('optimization-modal-overlay'),
            title: document.getElementById('modal-title'),
            content: document.getElementById('modal-content'),
            closeBtn: document.getElementById('modal-close-btn'),
            confirmBtn: document.getElementById('modal-confirm-btn'),
        }
    };

    // Módulo UI: Funciones que manipulan directamente la interfaz de usuario.
    const ui = {
        updateStatus(message, type = config.STATUS_TYPES.INFO, temporary = false) {
            // ... (Implementación idéntica a la original, pero usando config.STATUS_TYPES)
        },
        updateLargeTemperature(temp) {
            dom.largeTemp.textContent = `${temp.toFixed(2)}°C`;
        },
        updateLargeDelta(delta, p1s, p1m) {
            dom.largeDelta.textContent = `Δ ${delta.toFixed(2)}°C | P(1s): ${p1s.toFixed(2)}°C | P(1m): ${p1m.toFixed(2)}°C`;
        },
        updateInfoDisplay(session) {
            dom.roastId.textContent = session?.id || 'N/A';
            dom.roastName.textContent = session?.name || 'N/A';
            dom.roastDate.textContent = session?.startTime ? new Date(session.startTime).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'medium'}) : 'N/A';
        },
        togglePlottingControls(isPlotting) {
            dom.startPlottingBtn.disabled = isPlotting;
            dom.stopPlottingBtn.disabled = !isPlotting;
            dom.sessionNameInput.disabled = isPlotting;
            dom.saveSessionToggle.disabled = isPlotting;
        },
        renderSessionList() {
            dom.sessionList.innerHTML = '';
            if (!state.allRoastSessions || state.allRoastSessions.length === 0) {
                dom.sessionList.innerHTML = `<li style="text-align: center; color: var(--text-secondary);">No hay sesiones guardadas.</li>`;
                return;
            }
            const fragment = document.createDocumentFragment();
            state.allRoastSessions.slice().reverse().forEach(session => {
                // ... (Creación de elementos <li> idéntica a la original)
                fragment.appendChild(listItem);
            });
            dom.sessionList.appendChild(fragment);
        },
        applyTheme(theme) {
            document.body.classList.toggle('light-theme', theme === 'light');
            document.body.classList.toggle('dark-theme', theme === 'dark');
            dom.themeToggle.innerHTML = `<span class="material-icons">${theme === 'light' ? 'dark_mode' : 'light_mode'}</span>`;
            state.currentTheme = theme;
            localStorage.setItem('theme', theme);
            charts.reinitializeAll(); // Recrea los gráficos con los nuevos colores del tema
        },
        showModal(title, content) {
            dom.modal.title.innerHTML = title;
            dom.modal.content.innerHTML = content;
            dom.modal.overlay.classList.add('open');
        },
        hideModal() {
            dom.modal.overlay.classList.remove('open');
        }
    };

    // Módulo API: Centraliza todas las comunicaciones HTTP (fetch).
    const api = {
        async getSessions() {
            const response = await fetch(`${config.API_URL(config.HOST)}/roast_sessions`);
            if (!response.ok) throw new Error('Failed to fetch sessions');
            return response.json();
        },
        async getSessionDetails(sessionId) {
            const response = await fetch(`${config.API_URL(config.HOST)}/roast_sessions/${sessionId}`);
            if (!response.ok) throw new Error('Failed to fetch session details');
            return response.json();
        },
        async deleteSession(sessionId) {
            const response = await fetch(`${config.API_URL(config.HOST)}/roast_sessions/${sessionId}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Failed to delete session');
            return response.json();
        },
        async postMark(mark) {
            await fetch(`${config.API_URL(config.HOST)}/roast_sessions/mark`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(mark)
            });
        },
        async getGeminiAnalysis(prompt) {
            // ... (Implementación de la llamada a Gemini, igual que en la original)
            // ¡Recordar la advertencia sobre la API Key!
        }
    };
    
    // Módulo Charts: Gestiona todo lo relacionado con Chart.js.
    const charts = {
        // ... (Aquí irían los plugins complejos como 'line_p' y funciones de cálculo)

        initializeMainChart() {
            if (state.dataChart) state.dataChart.destroy();
            // ... (Lógica de configuración y creación del gráfico principal)
            state.dataChart = new Chart(dom.chartCanvas, { /* ... options ... */ });
        },
        initializeIndicatorChart() {
             if (state.indicatorChart) state.indicatorChart.destroy();
            // ... (Lógica de configuración y creación del gráfico indicador)
            state.indicatorChart = new Chart(dom.indicatorCanvas, { /* ... options ... */ });
        },
        reinitializeAll() {
            this.initializeMainChart();
            this.initializeIndicatorChart();
            // Si una sesión estaba cargada, la vuelve a cargar para que se vea con el nuevo tema
            if (state.loadedSessionId) {
                const sessionToReload = state.allRoastSessions.find(s => s.id === state.loadedSessionId);
                if(sessionToReload) app.loadSession(sessionToReload);
            }
        },
        addData(tempInt, tempFloat) {
            if (!state.dataChart || !state.isPlottingActive) return;
            state.dataChart.data.datasets[0].data[state.currentIndex] = tempInt;
            
            // ... (Lógica para añadir datos al gráfico indicador también)

            if (state.activeSession) {
                state.activeSession.data.push({
                    tiempo: state.dataChart.data.labels[state.currentIndex],
                    temperaturaInt: tempInt,
                });
            }
            state.currentIndex++;
            state.dataChart.update('none');
            dom.lastIntVal.textContent = `${tempInt.toFixed(2)} °C`;
            dom.lastFloatVal.textContent = `${tempFloat.toFixed(2)} °C`;
        },
        loadSessionData(sessionData) {
            if (!state.dataChart) return;
            this.unloadSessionData(); // Limpia datos anteriores
            
            // ... (Lógica para rellenar el dataset de "cargado" y sus marcadores)
            
            state.dataChart.update();
        },
        unloadSessionData() {
            if (!state.dataChart) return;
            state.dataChart.data.datasets[1].data.fill(null);
            state.dataChart.options.plugins.line_p.loadedMarkers = [];
            state.dataChart.update();
            dom.unloadSessionBtn.style.display = 'none';
        },
        resetLiveData() {
             if (!state.dataChart) return;
            state.dataChart.data.datasets[0].data = [];
            state.dataChart.options.plugins.line_p.liveMarkers = [];
            state.dataChart.update('none');
            // ... (Resetear también el gráfico indicador)
        }
    };
    
    // Módulo WebSocket: Gestiona la conexión y los mensajes.
    const websocket = {
        connect() {
            if (state.websocket && (state.websocket.readyState === WebSocket.OPEN || state.websocket.readyState === WebSocket.CONNECTING)) {
                return;
            }
            ui.updateStatus('Conectando...', config.STATUS_TYPES.INFO);
            state.websocket = new WebSocket(config.WEBSOCKET_URL(config.HOST));
            this.setupEventListeners();
        },
        setupEventListeners() {
            state.websocket.onopen = this.handleOpen;
            state.websocket.onmessage = this.handleMessage;
            state.websocket.onerror = this.handleError;
            state.websocket.onclose = this.handleClose;
        },
        handleOpen() {
            ui.updateStatus('Conectado', config.STATUS_TYPES.SUCCESS);
            dom.startPlottingBtn.disabled = false;
            dom.hostConnection.textContent = state.websocket.url;
            websocket.sendMessage({ cmd: "get" });
        },
        handleMessage(event) {
            const data = JSON.parse(event.data);
            // ... (Lógica para manejar los diferentes tipos de mensajes del servidor)
            // Ejemplo: if (data.type === 'temp') { app.handleTempData(data); }
        },
        handleError() {
            ui.updateStatus('Error de Conexión', config.STATUS_TYPES.ERROR);
            setTimeout(() => websocket.connect(), config.RECONNECT_DELAY);
        },
        handleClose() {
            ui.updateStatus('Desconectado', config.STATUS_TYPES.ERROR);
            ui.togglePlottingControls(false); // Asegura que los controles estén usables para reintentar
            dom.stopPlottingBtn.disabled = true;
            state.websocket = null;
            setTimeout(() => websocket.connect(), config.RECONNECT_DELAY);
        },
        sendMessage(payload) {
            if (state.websocket && state.websocket.readyState === WebSocket.OPEN) {
                state.websocket.send(JSON.stringify(payload));
            }
        }
    };
    
    // Módulo Principal de la App: Orquesta todos los demás módulos.
    const app = {
        init() {
            // Inicializa la UI y los listeners
            this.setupEventListeners();
            ui.applyTheme(state.currentTheme);
            charts.initializeMainChart();
            charts.initializeIndicatorChart();
            
            // Carga datos iniciales
            websocket.connect();
            this.loadAndRenderSessions();
        },
        setupEventListeners() {
            // Eventos de la App
            dom.themeToggle.addEventListener('click', () => ui.applyTheme(state.currentTheme === 'dark' ? 'light' : 'dark'));
            dom.startPlottingBtn.addEventListener('click', () => this.startPlotting());
            dom.stopPlottingBtn.addEventListener('click', () => this.stopPlotting());
            dom.resetChartBtn.addEventListener('click', () => this.resetLiveChart());
            dom.applySettingsBtn.addEventListener('click', () => this.applyChartSettings());
            dom.optimizeProfileBtn.addEventListener('click', () => this.optimizeProfile());

            // Eventos de la lista de sesiones (delegación)
            dom.sessionList.addEventListener('click', (e) => {
                const loadBtn = e.target.closest('.load-session-btn');
                const deleteBtn = e.target.closest('.delete-session-btn');
                if (loadBtn) {
                    const session = state.allRoastSessions.find(s => s.id === loadBtn.dataset.sessionId);
                    if(session) this.loadSession(session);
                }
                if (deleteBtn) {
                    this.deleteSession(deleteBtn.dataset.sessionId, deleteBtn.dataset.sessionName);
                }
            });

            // Eventos de acción rápida
            for (const [eventType, button] of Object.entries(dom.eventButtons)) {
                button.addEventListener('click', () => this.recordEvent(eventType));
            }
            
            // Eventos del Modal
            dom.modal.closeBtn.addEventListener('click', ui.hideModal);
            dom.modal.confirmBtn.addEventListener('click', ui.hideModal);
        },
        
        // --- Lógica Principal ---
        async loadAndRenderSessions() {
            try {
                const data = await api.getSessions();
                state.allRoastSessions = data.sessions || [];
                ui.renderSessionList();
            } catch (error) {
                console.error(error);
                ui.updateStatus('Error al cargar sesiones', config.STATUS_TYPES.ERROR, true);
            }
        },
        startPlotting() {
            if (!state.websocket || state.websocket.readyState !== WebSocket.OPEN) {
                 ui.updateStatus('WebSocket no conectado.', config.STATUS_TYPES.ERROR, true);
                return;
            }
            state.isPlottingActive = true;
            ui.togglePlottingControls(true);
            
            state.activeSession = {
                id: null, // El servidor lo asignará
                name: dom.sessionNameInput.value.trim() || `Sesión del ${new Date().toLocaleString('es-ES')}`,
                shouldSave: dom.saveSessionToggle.checked,
                startTime: new Date().toISOString(),
                data: [],
                markers: []
            };

            ui.updateInfoDisplay(state.activeSession);
            ui.updateStatus(`Iniciando: ${state.activeSession.name}`, config.STATUS_TYPES.SUCCESS);

            if (state.activeSession.shouldSave) {
                websocket.sendMessage({ cmd: "start", session_name: state.activeSession.name });
            }
        },
        stopPlotting() {
            state.isPlottingActive = false;
            ui.togglePlottingControls(false);
            ui.updateStatus('Gráficado detenido', config.STATUS_TYPES.INFO);

            if (state.activeSession && state.activeSession.shouldSave) {
                websocket.sendMessage({ cmd: "stop" });
                this.loadAndRenderSessions(); // Recarga la lista para ver la nueva sesión
            }
            
            state.activeSession = null;
            ui.updateInfoDisplay(null);
        },
        resetLiveChart() {
            if (state.isPlottingActive) this.stopPlotting();
            state.currentIndex = 0;
            charts.resetLiveData();
            ui.updateLargeTemperature(0);
            ui.updateLargeDelta(0,0,0);
            ui.updateStatus('Datos en vivo reiniciados.', config.STATUS_TYPES.INFO);
        },
        recordEvent(eventType) {
             if (!state.isPlottingActive || !state.activeSession) {
                ui.updateStatus('Inicia el gráficado para registrar eventos.', config.STATUS_TYPES.WARNING, true);
                return;
            }
            // ... (Lógica de validación de eventos, igual que en la original)

            const marker = { type: eventType, chartIndex: state.currentIndex > 0 ? state.currentIndex - 1 : 0 };
            state.activeSession.markers.push(marker);
            state.dataChart.options.plugins.line_p.liveMarkers = state.activeSession.markers;
            state.dataChart.update();

             if (state.activeSession.shouldSave) {
                api.postMark({
                    session_id: state.activeSession.id,
                    mark_name: eventType,
                    create_at: marker.chartIndex
                });
            }
        },
        // ... (resto de funciones como deleteSession, loadSession, applyChartSettings, etc.,
        // adaptadas para usar los módulos `state`, `api`, `ui` y `charts`).
    };

    // ¡Inicia la aplicación cuando la página esté lista!
    window.onload = () => app.init();

</script>
</body>
</html>


